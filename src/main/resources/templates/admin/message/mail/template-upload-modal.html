<div class="modal-header">
    <button aria-label="Close" class="close" data-dismiss="modal" type="button">
        <span aria-hidden="true">×</span></button>
    <h4 class="modal-title">邮件模版文件上传框</h4>
    <small></small>
</div>
<div class="modal-body">
    <div id="upload-1" class="container-fluid upload-wrapper">
        <div class="center-block">
            <div class="row">
                <div class="col-md-12">
                    <div class="upload-area">
                        <p class="text-sub text-center">请选择需要上传的文件</p>
                    </div>
                    <div>
                        <ul class="upload-tip">
                            <!--<li>不能上传超过 500M 的文件</li>-->
                        </ul>
                        <div class="upload-btn">
                            选择文件
                        </div>
                    </div>
                </div>
                <!--<div class="col-md-4">-->
                <!--参数设置-->
                <!--</div>-->
            </div>
        </div>
    </div>
</div>
<div class="modal-footer">
    <button class="btn btn-default" data-dismiss="modal" type="button">取消</button>
    <button class="btn btn-primary" onclick="submit()" type="submit">确定</button>
</div>
<script>
    $(function () {
        var Uploader = {
            id: undefined,
            $textSub: undefined,
            $uploadArea: undefined, // 上传显示信息
            uploader: undefined,
            option: undefined,
            count: 0, // 当前上传的数量
            init: function (option) {
                var that = this;
                this.option = option;
                this.id = option.id;
                this.$uploadArea = $(this.id + ' .upload-area');
                this.$textSub = $(this.id + ' .text-sub');

                this.uploader = WebUploader.create({
                    auto: true,
                    swf: option.swf || '/static/dist/webuploader/Uploader.swf',
                    server: option.server || 'http://localhost:8080/public/upload',
                    pick: {
                        id: this.id + ' .upload-btn',
                        multiple: true
                    },
                    accept: option.accept,
                    resize: true
                }).on('uploadBeforeSend', function (object, data, headers) {
                    headers[option.header] = option.token;
                }).on('fileQueued', function (file) {
                    if (!!that.option.maxCount
                        && that.count >= that.option.maxCount) {
                        layer.msg('上传文件数量已到达限制', {icon: 2});
                        return;
                    }
                    that.$textSub.hide();
                    that.$uploadArea.append(that.getUploadProgressHtml(file));
                    var $this = $(that.id + ' .' + file.id);
                    $this.find('.operating')
                        .not('.cancel-upload').hide();
                    that.count++;
                }).on('uploadProgress', function (file, percentage) {
                    // 上传中
                    var $this = $(that.id + ' .' + file.id);
                    that.progress($this, percentage);
                }).on('fileDequeued', function () {
                    that.count--;
                }).on('uploadError', function (file, reason) {
                    // 上传出错
                    var $this = $(that.id + ' .' + file.id);
                    that.error($this, reason);
                }).on('uploadSuccess', function (file, data) {
                    var $this = $(that.id + ' .' + file.id);
                    if (data.code === 200) {
                        $this.data('fid', data.id);
                        that.success($this);
                    } else if (data.code === 220) {
                        that.exits($this);
                    } else {
                        that.error($this, data.message);
                    }
                });

                /**
                 * 取消上传, 仅从队列中移除
                 */
                this.$uploadArea.on('click', '.cancel-upload', function () {
                    var id = $(this).data('id');
                    that.cancelFile(id);
                });
                /**
                 * 删除上传文件, 仅从队列中移除, 从服务器上移除
                 */
                this.$uploadArea.on('click', '.remove-upload', function () {
                    var id = $(this).data('id');
                    var fid = $(that.id + ' .' + id).data('fid');
                    if (!!that.option.removeServer) {
                        $.post(that.option.removeServer, {id: fid}, function (data) {
                            if (data.code === 200) {
                                that.cancelFile(id);
                            } else {
                                layer.msg(data.message, {icon: 2});
                                layer.confirm('仅从上传队列中移除?',
                                    ["确定", "取消"], function () {
                                        that.cancelFile(id);
                                    });
                            }
                        });
                    } else {
                        that.cancelFile(id);
                    }
                });
                return this;
            },
            getUploadProgressHtml: function (file) {
                return '<div class="upload-progress ' + file.id + '">\n' +
                    '                        <div class="progress-info">\n' +
                    '                            <a href="javascript:;;" class="operating cancel-upload" data-id="' + file.id + '">\n' +
                    '                                <i class="glyphicon glyphicon-ban-circle"></i>\n' +
                    '                            </a>\n' +
                    '                            <span class="operating success-upload">\n' +
                    '                                <i class="glyphicon glyphicon-ok"></i>\n' +
                    '                            </span>\n' +
                    '                            <a href="javascript:;;" class="operating remove-upload" data-id="' + file.id + '">\n' +
                    '                                <i class="glyphicon glyphicon-trash"></i>\n' +
                    '                            </a>\n' +
                    '                            <span class="file-info">\n' +
                    '                                <span title="' + file.name + '" class="file-name">' + file.name + '</span>\n' +
                    '                                <span class="file-size">' + this.formatBytes(file.size) + '</span>\n' +
                    '                            </span>\n' +
                    '                            <span class="upload-status"></span>\n' +
                    '                        </div>\n' +
                    '                        <div class="progress-bg" style="width: 0%;"></div>\n' +
                    '                    </div>';
            },
            formatBytes: function (bytes) {
                if (bytes === 0) return '0 B';
                var k = 1000, // or 1024
                    sizes = ['B', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'],
                    i = Math.floor(Math.log(bytes) / Math.log(k));

                return (bytes / Math.pow(k, i)).toPrecision(3) + ' ' + sizes[i];
            },
            error: function (uploadProgress, reason) {
                var $this = $(uploadProgress);
                $this.find('.operating').show()
                    .not('.cancel-upload').hide();
                $this.find('.progress-bg').addClass('error')
                    .css('width', '100%');
                $this.find('.file-size').text('错误: ' + reason);
            },
            exits: function (uploadProgress) {
                var $this = $(uploadProgress);
                $this.find('.operating').show()
                    .not('.cancel-upload').hide();
                $this.find('.progress-bg').addClass('exist')
                    .css('width', '100%');
                $this.find('.file-size').text('文件已存在');
                $this.find('.upload-status').text('');
            },
            success: function (uploadProgress) {
                var $this = $(uploadProgress);
                $this.find('.operating').show()
                    .not('.success-upload,.remove-upload').hide();
                this.progress(uploadProgress, 100);
                $this.find('.progress-bg').addClass("success");
            },
            progress: function (uploadProgress, percentage) {
                var $this = $(uploadProgress);
                var value = percentage + '%';
                $this.find('.progress-bg').css('width', value);
                $this.find('.upload-status').text(value);
            },
            cancelFile: function (id) {
                $(this.id + ' .' + id).remove();
                this.uploader.cancelFile(id, true);
                if (!$('.upload-progress').length) {
                    this.$textSub.show();
                }
            },
            getFilesId: function () {
                return $(this.id + ' .upload-progress').data('fid');
            }
        };
        Uploader.init({
            id: '#upload-1',
            removeServer: '/admin/system/file/delete',
            maxCount: 8,
            server: '/admin/system/file/upload',
            token: $('meta[name="_csrf"]').attr('content'),
            header: $('meta[name="_csrf_header"]').attr('content')
        });

        $('#js-template-modal').on('shown.bs.modal', function () {
            Uploader.uploader.refresh();
        })
    });
    function submit() {
        console.log(Uploader.getFilesId());
    }
</script>